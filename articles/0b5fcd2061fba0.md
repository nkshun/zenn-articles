---
title: "ãŸã¶ã‚“setIntervalå†…ã‹ã‚‰å¤–ã«ã‚¨ãƒ©ãƒ¼throwã¯ã§ããªã„ã‹ã‚‰è«¦ã‚ã‚ˆã†"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nodejs", "promise", "generator"]
published: false
---

ã“ã‚“ãªã‚¨ãƒ©ãƒ¼ã‚’çµŒé¨“ã—ãŸ
UnhandledPromiseRejectionWarning
ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã¦ãªã„Promiseã®RejectãŒã‚ã‚‹ãã£ã¦ã„ã†è­¦å‘Š
```bash
(node:29591) UnhandledPromiseRejectionWarning: ReferenceError: e is not defined
    at /Users/nakamurashunsuke/docs/10_project/the-harmony/10_cmm/comomon-api-server-ts/src/models/BaseFileReader.ts:44:33
(Use `node --trace-warnings ...` to show where the warning was created)
(node:29591) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag `--unhandled-rejections=strict` (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 1)
(node:29591) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.
```

ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ã£ã¦ã“ã¨ã¯ã‚­ãƒ£ãƒƒãƒã—ãŸã‚¨ãƒ©ãƒ¼ã‚’ã©ã“ã«ã‚‚throwã›ãšã«ä½•ã‹ã—ã‚‰ã®å‡¦ç†ã‚’ã™ã‚‹ã“ã¨
```typescript
const alwaysRejectFunc = () => {
  return new Promise((_, reject) => {
    return reject('â—‹â—‹å¤±æ•—')
  })
}

// rejectã‚’ãƒãƒ³ãƒ‰ãƒ«ã—ã¦ã‚‹
try {
    (async () => {
      await alwaysRejectFunc()
    })()
    (async () => {
      await alwaysRejectFunc()
    })()
} catch(err) {
    console.log('å•é¡Œç™ºç”Ÿï¼', err)
};

// rejectã‚’ãƒãƒ³ãƒ‰ãƒ«ã—ã¦ãªã„
try {
    (async () => {
      await alwaysRejectFunc()
    })()
    (async () => {
      await alwaysRejectFunc()
    })()
} catch(err) {
    throw new Error('å•é¡Œç™ºç”Ÿï¼', err)
};
```

ä»Šå›ç§ãŒé­é‡ã—ãŸã‚¨ãƒ©ãƒ¼ã¯ã“ã‚“ãªå‡¦ç†ã‹ã‚‰ç™ºç”Ÿã—ã¦ãŸ

éåŒæœŸå‡¦ç†å†…ã‹ã‚‰throwã—ã¦ã‚‚å¤–å´ã§ã‚­ãƒ£ãƒƒãƒã§ããªã„ã‚‰ã—ã„
setIntervalã®å¤–ã«throwã§ãã¦ãŠã‚‰ãšã€try catchã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãŒè¦‹ãˆã¦ãªã„çŠ¶æ…‹
```typescript
      try {
        setInterval(() => {
            (async (): Promise<void> => await read())().catch(error => {
                throw new Error(error);
            });
        }, 600000);
      } catch(e) {
          logger.system.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã®å®šæœŸå®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', error);
      }
```

ã“ã†ã™ã‚‹ã—ã‹ãªã„
```typescript
        setInterval(() => {
            (async (): Promise<void> => await read())().catch(error => {
                logger.system.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã®å®šæœŸå®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', error);
            });
        }, 600000);
```


## è©¦è¡ŒéŒ¯èª¤ã—ãŸã‘ã©ãƒ€ãƒ¡ã ã£ãŸã‚„ã¤

### promise

setIntervalã®åˆå›ã®ã‚¨ãƒ©ãƒ¼ã¯ã‚­ãƒ£ãƒƒãƒã§ãã‚‹ãŒã€2å›ç›®ç§»è¡Œã¯ã§ããªã„
```typescript
function async createInterval(interval: number): Promise<void> {
		await readInterval(interval);
}

// å®šæœŸèª­ã¿è¾¼ã¿
function readInterval(interval: number): Promise<void> {
	return new Promise((resolve, reject) => {
     setInterval(() => {
        (async (): Promise<void> => {
						this.read()
						resolve()
				)().catch(e => {
            reject(e);
        });
    }, interval);
	})
}
```

### generator
generatorã®throwãªã®ã§æ‹¾ãˆã‚‹ã¨æ€ã£ãŸã‘ã©ãƒ€ãƒ¡ã ã£ãŸ
```typescript
async function createInterval(interval: number): Promise<void> {
    this.readGenerator(interval).next() // ã“ã“ã‹ã‚‰ä¸Šã«throwã—ã¦ã»ã—ã„ï¼ â†’ ã ã‚ã ã£ãŸ
}

function * readGenerator(interval: number): Generator<NodeJS.Timer> {
    yield this.readInterval(interval, this.readGenerator());
}

// å®šæœŸèª­ã¿è¾¼ã¿
function readInterval(interval,: number, generator: Generator<NodeJS.Timer>): NodeJS.Timer {
    return setInterval(() => {
        (async (): Promise<void> =>  this.read())().catch(e => {
            generator.throw(e);
        });
    }, interval);
}
```

## generatorå‚è€ƒè¨˜äº‹
[How can I write a generator in a JavaScript class?](https://stackoverflow.com/questions/39197811/how-can-i-write-a-generator-in-a-javascript-class)
[JavaScriptã¨éåŒæœŸã®ã‚¨ãƒ©ãƒ¼å‡¦ç†](https://techblog.yahoo.co.jp/programming/javascript_error/)

